<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Dodger: Galactic Terminal</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    
    <style>
        :root { 
            --neon-pink: #ff2d95; 
            --neon-blue: #00f2ff; 
            --deep-purple: #2d004d;
        }

        body {
            background-color: #010101;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; font-family: 'Courier New', Courier, monospace;
            color: var(--neon-blue); overflow: hidden;
            touch-action: none;
        }

        body::after {
            content: " ";
            position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.04), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.04));
            z-index: 100; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }

        #main-container {
            display: flex; flex-wrap: wrap; justify-content: center; align-items: flex-start; gap: 15px; padding: 10px;
        }

        .terminal-panel {
            width: 180px; height: 450px; background: rgba(5, 5, 15, 0.85);
            border: 1px solid #222; padding: 12px; font-size: 0.65rem; color: #0f0;
            overflow: hidden; display: flex; flex-direction: column; gap: 4px;
            box-shadow: 0 0 15px rgba(0,0,0,1);
        }

        .bottom-terminal {
            width: 100%; max-width: 800px; height: 60px; background: rgba(5, 5, 10, 0.9);
            border: 1px solid #222; margin-top: 15px; padding: 10px; font-size: 0.7rem;
            display: flex; justify-content: space-around; align-items: center; color: #ffff00;
        }

        #game-wrapper {
            position: relative; width: 90vw; max-width: 400px; aspect-ratio: 4 / 5;
            padding: 5px; border-radius: 15px;
            background: linear-gradient(135deg, var(--neon-pink), var(--neon-blue));
            box-shadow: 0 0 40px rgba(0, 242, 255, 0.2);
        }

        #canvas-container {
            position: relative; width: 100%; height: 100%;
            border-radius: 12px; overflow: hidden; background: #000;
        }

        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 0, 15, 0.96); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 20; padding: 25px;
            text-align: center;
        }

        .hidden { display: none !important; }

        button {
            background: rgba(255, 45, 149, 0.1); border: 2px solid var(--neon-pink); color: var(--neon-pink);
            padding: 15px 35px; cursor: pointer; text-transform: uppercase; 
            font-weight: bold; letter-spacing: 4px; transition: 0.2s;
            box-shadow: 0 0 10px var(--neon-pink); margin-top: 15px;
            z-index: 30; pointer-events: auto;
        }

        button:active { background: var(--neon-pink); color: #fff; transform: scale(0.95); }

        #progress-bar { width: 100%; max-width: 400px; height: 4px; background: #111; margin-top: 10px; }
        #progress-fill { width: 0%; height: 100%; background: var(--neon-pink); transition: width 0.1s; }

        @media (max-width: 800px) { .terminal-panel { display: none; } }
    </style>
</head>
<body>

    <div id="main-container">
        <div class="terminal-panel" id="term-left">
            <div style="color: var(--neon-pink)">[MISSION_LOG]</div>
        </div>

        <div id="game-side">
            <div style="margin-bottom: 8px; letter-spacing: 2px; font-size: 0.8rem; font-weight: bold; display: flex; justify-content: space-between;">
                <span>SECTOR <span id="level-val">1</span></span> 
                <span>DATA <span id="score-val">0</span></span>
            </div>

            <div id="game-wrapper">
                <div id="canvas-container">
                    <canvas id="bgCanvas" width="400" height="500"></canvas>
                    <canvas id="gameCanvas" width="400" height="500"></canvas>

                    <div id="start-screen" class="overlay">
                        <h1 style="color: var(--neon-pink); text-shadow: 0 0 15px var(--neon-pink); margin: 0; font-size: 1.8rem;">GALACTIC DODGER</h1>
                        <div style="font-size: 0.65rem; color: #888; margin: 15px 0; text-align: left; line-height: 1.6;">
                            <span style="color: var(--neon-blue)">> STATUS:</span> ENGINES PRIMED<br>
                            <span style="color: var(--neon-blue)">> HIGH SCORE:</span> <span id="high-score-display" style="color: #fff">0000</span><br>
                        </div>
                        <button id="btn-engage">ENGAGE</button>
                    </div>

                    <div id="break-screen" class="overlay hidden">
                        <h2 style="color: var(--neon-blue);">SECTOR CLEARED</h2>
                        <button id="btn-next">NEXT SECTOR</button>
                    </div>

                    <div id="end-screen" class="overlay hidden">
                        <h1 style="color: red;">HULL BREACH</h1>
                        <div style="color: #fff; margin-bottom: 10px;">FINAL DATA: <span id="final-score">0</span></div>
                        <button id="btn-respawn">RESPAWN</button>
                    </div>
                </div>
            </div>
            <div id="progress-bar"><div id="progress-fill"></div></div>
        </div>

        <div class="terminal-panel" id="term-right">
            <div style="color: var(--neon-blue)">[NAV_COMP]</div>
            <hr style="border: 0; border-top: 1px solid #222; margin: 5px 0;">
            <div style="color: #fff">TOP_DATA_RECORDS:</div>
            <div id="high-score-list" style="color: #ffff00">0</div>
        </div>
    </div>

    <div class="bottom-terminal">
        <div>SYS_TIME: <span id="clock">00:00:00</span></div>
        <div style="color: #0f0;">STABILITY: <span id="stability">100</span>%</div>
    </div>

    <script type="py">
        import js
        from pyodide.ffi import create_proxy
        import random
        import math
        from datetime import datetime

        game_canvas = js.document.getElementById("gameCanvas")
        ctx = game_canvas.getContext("2d")
        bg_canvas = js.document.getElementById("bgCanvas")
        bg_ctx = bg_canvas.getContext("2d")
        
        player = {"x": 185, "y": 430}
        enemies = []
        stars = [{"x": random.random()*400, "y": random.random()*500, "s": random.random()*2} for _ in range(60)]
        
        score, level = 0, 1
        game_active, in_break = False, False

        # --- SCOREBOARD LOGIC ---
        def get_high_score():
            hs = js.localStorage.getItem("galactic_dodger_highscore")
            return int(hs) if hs else 0

        def save_high_score(new_score):
            if new_score > get_high_score():
                js.localStorage.setItem("galactic_dodger_highscore", str(new_score))
                return True
            return False

        def update_score_displays():
            hs = get_high_score()
            js.document.getElementById("high-score-display").innerText = str(hs)
            js.document.getElementById("high-score-list").innerText = f"RECORD: {hs}"

        update_score_displays()

        def log_term(side, msg):
            panel = js.document.getElementById(f"term-{side}")
            if not panel: return
            div = js.document.createElement("div")
            div.innerText = f"> {msg}"
            panel.appendChild(div)
            if panel.children.length > 20: panel.removeChild(panel.children.item(1))

        keys = {"ArrowLeft": False, "ArrowRight": False}
        def on_key(e, state): 
            if e.code in keys: keys[e.code] = state
        js.window.addEventListener("keydown", create_proxy(lambda e: on_key(e, True)))
        js.window.addEventListener("keyup", create_proxy(lambda e: on_key(e, False)))

        def handle_touch(e):
            e.preventDefault()
            rect = game_canvas.getBoundingClientRect()
            touch = e.touches.item(0)
            tx = (touch.clientX - rect.left) * (400 / rect.width)
            if tx < 200: keys["ArrowLeft"], keys["ArrowRight"] = True, False
            else: keys["ArrowRight"], keys["ArrowLeft"] = True, False

        game_canvas.addEventListener("touchstart", create_proxy(handle_touch))
        game_canvas.addEventListener("touchend", create_proxy(lambda e: keys.update({"ArrowLeft":False, "ArrowRight":False})))

        def startGame(e):
            global game_active, score, level, enemies
            js.document.getElementById("start-screen").classList.add("hidden")
            js.document.getElementById("end-screen").classList.add("hidden")
            game_active = True
            log_term("left", "CORE_REBOOT_SUCCESS")

        def continueGame(e):
            global game_active, in_break, enemies
            js.document.getElementById("break-screen").classList.add("hidden")
            game_active, in_break, enemies = True, False, []

        btn_engage = js.document.getElementById("btn-engage")
        btn_next = js.document.getElementById("btn-next")
        btn_respawn = js.document.getElementById("btn-respawn")
        
        btn_engage.addEventListener("click", create_proxy(startGame))
        btn_next.addEventListener("click", create_proxy(continueGame))
        btn_respawn.addEventListener("click", create_proxy(lambda e: js.location.reload()))

        def draw_bg():
            bg_ctx.fillStyle = "#00050a"
            bg_ctx.fillRect(0, 0, 400, 500)
            for s in stars:
                s["y"] += (1.5 + level * 0.2) * s["s"]
                if s["y"] > 500: s["y"] = 0; s["x"] = random.random()*400
                bg_ctx.fillStyle = "rgba(255, 255, 255, 0.6)"
                bg_ctx.fillRect(s["x"], s["y"], s["s"], s["s"])

        def update(timestamp):
            global score, level, game_active, in_break
            draw_bg()
            js.document.getElementById("clock").innerText = datetime.now().strftime("%H:%M:%S")
            
            if not game_active or in_break:
                js.requestAnimationFrame(create_proxy(update))
                return

            ctx.clearRect(0, 0, 400, 500)
            
            # Increased Player Speed (12 instead of 8)
            if keys["ArrowLeft"] and player["x"] > 0: player["x"] -= 12
            if keys["ArrowRight"] and player["x"] < 370: player["x"] += 12
            
            ctx.shadowBlur = 10; ctx.shadowColor = "#00f2ff"
            ctx.fillStyle = "#fff"; ctx.fillRect(player["x"], player["y"], 30, 30)

            # Faster Initial Speed (5.0 instead of 3.2)
            fall_speed = 5.0 + (level * 0.5)
            spawn_rate = 0.02 + (level * 0.001)

            if random.random() < spawn_rate:
                enemies.append({"x": random.randint(0,370), "y": -30})

            for e in enemies[:]:
                e["y"] += fall_speed
                ctx.shadowBlur = 8; ctx.shadowColor = "#ff2d95"
                ctx.fillStyle = "#ff2d95"; ctx.fillRect(e["x"], e["y"], 25, 25)

                # Collision
                if (player["x"] < e["x"]+25 and player["x"]+30 > e["x"] and player["y"] < e["y"]+25 and player["y"]+30 > e["y"]):
                    game_active = False
                    save_high_score(score)
                    update_score_displays()
                    js.document.getElementById("final-score").innerText = str(score)
                    js.document.getElementById("end-screen").classList.remove("hidden")

                if e["y"] > 500:
                    enemies.remove(e)
                    score += 5
                    js.document.getElementById("score-val").innerText = str(score)
                    js.document.getElementById("progress-fill").style.width = f"{(score % 100)}%"
                    
                    if score > 0 and score % 100 == 0:
                        level += 1
                        in_break = True
                        js.document.getElementById("level-val").innerText = str(level)
                        js.document.getElementById("break-screen").classList.remove("hidden")
                        log_term("left", f"WARP_TO_SEC_{level}")

            js.requestAnimationFrame(create_proxy(update))

        update(0)
    </script>
</body>
</html>